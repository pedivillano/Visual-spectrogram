<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>步进音乐播放器与频谱分析器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #f1f1f1;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
            background-color: rgba(25, 25, 35, 0.9);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            padding: 30px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 20px;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00dbde, #fc00ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .subtitle {
            font-size: 1.1rem;
            color: #aaa;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 900px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        .player-section, .visualizer-section {
            background-color: rgba(30, 30, 40, 0.8);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #00dbde;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            font-size: 1.3rem;
        }
        
        /* 文件上传区域 */
        .file-upload {
            background-color: rgba(40, 40, 55, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px dashed rgba(0, 219, 222, 0.3);
            text-align: center;
            transition: all 0.3s;
        }
        
        .file-upload:hover {
            border-color: #00dbde;
        }
        
        .file-label {
            display: block;
            cursor: pointer;
            padding: 15px;
        }
        
        .file-label i {
            font-size: 2.5rem;
            color: #00dbde;
            margin-bottom: 10px;
        }
        
        .file-label h3 {
            margin-bottom: 10px;
            font-size: 1.3rem;
        }
        
        .file-label p {
            color: #aaa;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .selected-file {
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 0.9rem;
            word-break: break-all;
        }
        
        /* 播放器控制区域 */
        .player-controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .track-info {
            text-align: center;
            padding: 15px;
            background-color: rgba(40, 40, 55, 0.8);
            border-radius: 10px;
        }
        
        .track-title {
            font-size: 1.4rem;
            margin-bottom: 5px;
            color: #fff;
        }
        
        .track-artist, .track-album {
            color: #aaa;
            font-size: 1rem;
            margin-bottom: 3px;
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #aaa;
        }
        
        .progress-container {
            width: 100%;
            height: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00dbde, #fc00ff);
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s;
        }
        
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 15px 0;
        }
        
        .btn {
            background-color: rgba(40, 40, 55, 0.8);
            border: none;
            color: #fff;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .btn:hover {
            background-color: rgba(0, 219, 222, 0.2);
            transform: scale(1.05);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #00dbde, #fc00ff);
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }
        
        .step-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
        }
        
        .step-btn {
            padding: 10px 20px;
            background-color: rgba(40, 40, 55, 0.8);
            border: none;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }
        
        .step-btn:hover {
            background-color: rgba(0, 219, 222, 0.2);
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .volume-slider {
            flex-grow: 1;
            height: 6px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            outline: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00dbde;
            cursor: pointer;
        }
        
        /* 频谱分析区域 */
        .visualizer-container {
            width: 100%;
            height: 350px;
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        .settings {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .setting-group {
            flex: 1;
            min-width: 150px;
        }
        
        .setting-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 0.9rem;
        }
        
        .setting-group select, .setting-group input {
            width: 100%;
            padding: 10px;
            background-color: rgba(40, 40, 55, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
        }
        
        .setting-group input {
            cursor: pointer;
        }
        
        .instructions {
            background-color: rgba(40, 40, 55, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }
        
        .instructions h3 {
            color: #00dbde;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        
        .instructions ul {
            padding-left: 20px;
            color: #aaa;
            line-height: 1.6;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        .instructions code {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #777;
            font-size: 0.9rem;
        }
        
        /* 动画效果 */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .playing {
            animation: pulse 2s infinite;
        }
        
        .hidden {
            display: none;
        }
        
        .audio-warning {
            background-color: rgba(255, 100, 100, 0.2);
            border-left: 4px solid #ff6464;
            padding: 12px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 0.9rem;
        }
        
        .audio-warning i {
            margin-right: 8px;
            color: #ff6464;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-music"></i> 步进音乐播放器与频谱分析器</h1>
            <p class="subtitle">加载音频文件，以步进方式控制播放，同时实时查看音频频谱分析</p>
        </header>
        
        <div class="content">
            <div class="player-section">
                <h2 class="section-title"><i class="fas fa-play-circle"></i> 播放控制</h2>
                
                <div class="file-upload">
                    <label for="audioFile" class="file-label">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>点击上传音频文件</h3>
                        <p>支持 MP3, WAV, OGG 格式</p>
                        <div class="btn">选择文件</div>
                    </label>
                    <input type="file" id="audioFile" class="file-input" accept="audio/*">
                    <div id="selectedFileInfo" class="selected-file hidden">
                        <strong>已选择文件:</strong> <span id="fileName"></span>
                    </div>
                    <div id="audioWarning" class="audio-warning hidden">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>如果频谱不显示，请点击播放按钮启动音频上下文</span>
                    </div>
                </div>
                
                <div class="player-controls">
                    <div class="track-info">
                        <div class="track-title" id="trackTitle">未选择音频</div>
                        <div class="track-artist" id="trackArtist">等待音频文件</div>
                        <div class="track-album" id="trackAlbum">时长: --:--</div>
                        
                        <div class="time-display">
                            <span id="currentTime">00:00</span>
                            <span id="totalTime">00:00</span>
                        </div>
                        
                        <div class="progress-container" id="progressContainer">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="btn" id="stepBackwardBtn" title="后退5秒">
                            <i class="fas fa-backward"></i>
                        </button>
                        
                        <button class="btn btn-primary" id="playPauseBtn" title="播放/暂停">
                            <i class="fas fa-play" id="playIcon"></i>
                        </button>
                        
                        <button class="btn" id="stepForwardBtn" title="前进5秒">
                            <i class="fas fa-forward"></i>
                        </button>
                    </div>
                    
                    <div class="step-controls">
                        <button class="step-btn" id="smallStepBackwardBtn">
                            <i class="fas fa-step-backward"></i> 后退1秒
                        </button>
                        <button class="step-btn" id="smallStepForwardBtn">
                            <i class="fas fa-step-forward"></i> 前进1秒
                        </button>
                    </div>
                    
                    <div class="volume-control">
                        <i class="fas fa-volume-down"></i>
                        <input type="range" min="0" max="100" value="70" class="volume-slider" id="volumeSlider">
                        <i class="fas fa-volume-up"></i>
                    </div>
                </div>
            </div>
            
            <div class="visualizer-section">
                <h2 class="section-title"><i class="fas fa-wave-square"></i> 频谱分析</h2>
                
                <div class="visualizer-container">
                    <canvas id="visualizerCanvas"></canvas>
                </div>
                
                <div class="settings">
                    <div class="setting-group">
                        <label for="visualizerType">频谱类型</label>
                        <select id="visualizerType">
                            <option value="bars">柱状频谱</option>
                            <option value="waveform">波形图</option>
                            <option value="circular">圆形频谱</option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label for="colorScheme">颜色方案</label>
                        <select id="colorScheme">
                            <option value="neon">霓虹渐变</option>
                            <option value="ocean">海洋蓝</option>
                            <option value="fire">火焰红</option>
                            <option value="forest">森林绿</option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label for="stepSize">步进大小 (秒)</label>
                        <input type="range" id="stepSize" min="1" max="10" value="5">
                        <span id="stepSizeValue">5 秒</span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> 使用说明</h3>
            <ul>
                <li>点击"选择文件"按钮上传音频文件 (MP3, WAV, OGG格式)</li>
                <li>使用播放/暂停按钮控制音频播放</li>
                <li>使用步进按钮(前进/后退1秒或5秒)进行精确时间控制</li>
                <li>拖动进度条可快速跳转到特定时间点</li>
                <li>右侧的频谱分析器会实时显示音频的频谱数据</li>
                <li>可以使用上方的设置更改频谱显示类型和颜色方案</li>
                <li>调整步进大小滑块可改变步进按钮的时间间隔</li>
                <li><strong>注意：</strong>现代浏览器需要用户交互才能启动音频上下文，请确保在播放前先点击播放按钮</li>
            </ul>
        </div>
        
        <footer>
            <p>步进音乐播放器与频谱分析器 &copy; 2023 | 使用 Web Audio API 和 Canvas 技术构建</p>
        </footer>
    </div>

    <script>
        // 获取DOM元素
        const audioFileInput = document.getElementById('audioFile');
        const selectedFileInfo = document.getElementById('selectedFileInfo');
        const fileName = document.getElementById('fileName');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playIcon = document.getElementById('playIcon');
        const stepBackwardBtn = document.getElementById('stepBackwardBtn');
        const stepForwardBtn = document.getElementById('stepForwardBtn');
        const smallStepBackwardBtn = document.getElementById('smallStepBackwardBtn');
        const smallStepForwardBtn = document.getElementById('smallStepForwardBtn');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const currentTimeDisplay = document.getElementById('currentTime');
        const totalTimeDisplay = document.getElementById('totalTime');
        const volumeSlider = document.getElementById('volumeSlider');
        const visualizerCanvas = document.getElementById('visualizerCanvas');
        const visualizerType = document.getElementById('visualizerType');
        const colorScheme = document.getElementById('colorScheme');
        const stepSize = document.getElementById('stepSize');
        const stepSizeValue = document.getElementById('stepSizeValue');
        const trackTitle = document.getElementById('trackTitle');
        const trackArtist = document.getElementById('trackArtist');
        const trackAlbum = document.getElementById('trackAlbum');
        const audioWarning = document.getElementById('audioWarning');

        // 初始化音频上下文和分析器
        let audioContext;
        let audioSource;
        let analyser;
        let audioElement;
        let isPlaying = false;
        let animationId;
        let stepSizeInSeconds = 5;
        let audioInitialized = false;

        // 初始化Canvas
        const canvasCtx = visualizerCanvas.getContext('2d');
        visualizerCanvas.width = visualizerCanvas.clientWidth;
        visualizerCanvas.height = visualizerCanvas.clientHeight;

        // 颜色方案
        const colorSchemes = {
            neon: ['#00dbde', '#fc00ff'],
            ocean: ['#1e3c72', '#2a5298'],
            fire: ['#ff416c', '#ff4b2b'],
            forest: ['#56ab2f', '#a8e063']
        };

        // 初始化音频上下文（必须在用户交互后调用）
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('音频上下文已初始化');
            }
            return audioContext;
        }

        // 加载音频文件
        audioFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // 显示文件名
            fileName.textContent = file.name;
            selectedFileInfo.classList.remove('hidden');
            
            // 更新曲目信息
            trackTitle.textContent = file.name.replace(/\.[^/.]+$/, ""); // 移除扩展名
            trackArtist.textContent = "未知艺术家";
            trackAlbum.textContent = "文件大小: " + (file.size / (1024 * 1024)).toFixed(2) + " MB";

            // 创建音频元素
            const fileURL = URL.createObjectURL(file);
            if (audioElement) {
                audioElement.pause();
                if (audioSource) {
                    audioSource.disconnect();
                }
                cancelAnimationFrame(animationId);
            }

            audioElement = new Audio(fileURL);
            audioElement.crossOrigin = "anonymous";
            
            // 设置音量
            audioElement.volume = volumeSlider.value / 100;
            
            // 显示音频上下文警告
            audioWarning.classList.remove('hidden');
            
            // 更新总时长
            audioElement.addEventListener('loadedmetadata', function() {
                const duration = audioElement.duration;
                totalTimeDisplay.textContent = formatTime(duration);
                trackAlbum.textContent = `时长: ${formatTime(duration)} | 文件大小: ${(file.size / (1024 * 1024)).toFixed(2)} MB`;
            });

            // 当音频播放时更新进度
            audioElement.addEventListener('timeupdate', updateProgress);
            
            // 重置播放按钮
            playIcon.className = 'fas fa-play';
            isPlaying = false;
            playPauseBtn.classList.remove('playing');
            audioInitialized = false;
        });

        // 初始化音频分析器
        function initAudioAnalyser() {
            if (!audioContext) {
                initAudioContext();
            }
            
            if (!analyser) {
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.8;
            }
            
            if (audioElement && !audioSource) {
                audioSource = audioContext.createMediaElementSource(audioElement);
                audioSource.connect(analyser);
                analyser.connect(audioContext.destination);
            }
            
            audioInitialized = true;
            audioWarning.classList.add('hidden');
            console.log('音频分析器已初始化');
        }

        // 播放/暂停音频
        playPauseBtn.addEventListener('click', async function() {
            if (!audioElement) {
                alert('请先选择音频文件');
                return;
            }

            // 初始化音频上下文和分析器（第一次播放时）
            if (!audioInitialized) {
                initAudioContext();
                initAudioAnalyser();
                
                // 恢复音频上下文（如果被暂停）
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }
            }

            if (isPlaying) {
                audioElement.pause();
                playIcon.className = 'fas fa-play';
                playPauseBtn.classList.remove('playing');
                cancelAnimationFrame(animationId);
            } else {
                try {
                    // 确保音频上下文处于运行状态
                    if (audioContext.state === 'suspended') {
                        await audioContext.resume();
                    }
                    
                    await audioElement.play();
                    playIcon.className = 'fas fa-pause';
                    playPauseBtn.classList.add('playing');
                    
                    // 开始可视化
                    visualize();
                } catch (error) {
                    console.error('播放失败:', error);
                    alert('播放失败: ' + error.message);
                }
            }
            
            isPlaying = !isPlaying;
        });

        // 步进控制
        stepBackwardBtn.addEventListener('click', () => stepAudio(-stepSizeInSeconds));
        stepForwardBtn.addEventListener('click', () => stepAudio(stepSizeInSeconds));
        smallStepBackwardBtn.addEventListener('click', () => stepAudio(-1));
        smallStepForwardBtn.addEventListener('click', () => stepAudio(1));

        // 步进音频
        function stepAudio(seconds) {
            if (!audioElement) return;
            
            const newTime = audioElement.currentTime + seconds;
            audioElement.currentTime = Math.max(0, Math.min(newTime, audioElement.duration));
            updateProgress();
        }

        // 更新进度条
        function updateProgress() {
            if (!audioElement) return;
            
            const currentTime = audioElement.currentTime;
            const duration = audioElement.duration;
            
            if (duration) {
                const progressPercent = (currentTime / duration) * 100;
                progressBar.style.width = `${progressPercent}%`;
                currentTimeDisplay.textContent = formatTime(currentTime);
            }
        }

        // 点击进度条跳转
        progressContainer.addEventListener('click', function(e) {
            if (!audioElement || !audioElement.duration) return;
            
            const rect = this.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const width = rect.width;
            const clickPercent = clickX / width;
            
            audioElement.currentTime = clickPercent * audioElement.duration;
            updateProgress();
        });

        // 音量控制
        volumeSlider.addEventListener('input', function() {
            if (audioElement) {
                audioElement.volume = this.value / 100;
            }
        });

        // 步进大小控制
        stepSize.addEventListener('input', function() {
            stepSizeInSeconds = parseInt(this.value);
            stepSizeValue.textContent = `${stepSizeInSeconds} 秒`;
        });

        // 格式化时间 (秒 -> MM:SS)
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // 频谱可视化
        function visualize() {
            if (!analyser || !isPlaying) {
                // 如果不在播放状态，停止可视化
                cancelAnimationFrame(animationId);
                return;
            }

            // 调整Canvas大小
            visualizerCanvas.width = visualizerCanvas.clientWidth;
            visualizerCanvas.height = visualizerCanvas.clientHeight;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            const width = visualizerCanvas.width;
            const height = visualizerCanvas.height;
            
            // 获取当前可视化类型
            const type = visualizerType.value;
            
            // 获取当前颜色方案
            const colors = colorSchemes[colorScheme.value];

            function draw() {
                // 检查是否仍在播放
                if (!isPlaying) {
                    cancelAnimationFrame(animationId);
                    return;
                }
                
                // 清除画布
                canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                canvasCtx.fillRect(0, 0, width, height);
                
                // 获取音频数据
                if (type === 'waveform') {
                    analyser.getByteTimeDomainData(dataArray);
                } else {
                    analyser.getByteFrequencyData(dataArray);
                }

                // 根据类型绘制
                if (type === 'bars') {
                    drawBars(dataArray, bufferLength, width, height, colors);
                } else if (type === 'waveform') {
                    drawWaveform(dataArray, bufferLength, width, height, colors);
                } else if (type === 'circular') {
                    drawCircular(dataArray, bufferLength, width, height, colors);
                }

                // 继续动画
                animationId = requestAnimationFrame(draw);
            }

            // 开始绘制
            draw();
        }

        // 绘制柱状频谱
        function drawBars(dataArray, bufferLength, width, height, colors) {
            const barWidth = (width / bufferLength) * 2.5;
            let barHeight;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                barHeight = dataArray[i] / 2;
                
                // 创建渐变颜色
                const gradient = canvasCtx.createLinearGradient(0, height - barHeight, 0, height);
                gradient.addColorStop(0, colors[0]);
                gradient.addColorStop(1, colors[1]);
                
                canvasCtx.fillStyle = gradient;
                canvasCtx.fillRect(x, height - barHeight, barWidth, barHeight);
                
                x += barWidth + 1;
            }
        }

        // 绘制波形图
        function drawWaveform(dataArray, bufferLength, width, height, colors) {
            canvasCtx.lineWidth = 2;
            canvasCtx.strokeStyle = colors[0];
            canvasCtx.beginPath();

            const sliceWidth = width * 1.0 / bufferLength;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * height / 2;

                if (i === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }

                x += sliceWidth;
            }

            canvasCtx.lineTo(width, height / 2);
            canvasCtx.stroke();
        }

        // 绘制圆形频谱
        function drawCircular(dataArray, bufferLength, width, height, colors) {
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) * 0.3;
            
            canvasCtx.lineWidth = 2;
            
            // 绘制背景圆
            canvasCtx.beginPath();
            canvasCtx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            canvasCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            canvasCtx.stroke();
            
            for (let i = 0; i < bufferLength; i++) {
                const amplitude = dataArray[i];
                const angle = (i * Math.PI * 2) / bufferLength;
                
                // 创建渐变颜色
                const gradient = canvasCtx.createRadialGradient(
                    centerX, centerY, radius,
                    centerX, centerY, radius + amplitude / 2
                );
                gradient.addColorStop(0, colors[0]);
                gradient.addColorStop(1, colors[1]);
                
                canvasCtx.strokeStyle = gradient;
                
                const lineLength = amplitude * 0.5;
                const startX = centerX + Math.cos(angle) * radius;
                const startY = centerY + Math.sin(angle) * radius;
                const endX = centerX + Math.cos(angle) * (radius + lineLength);
                const endY = centerY + Math.sin(angle) * (radius + lineLength);
                
                canvasCtx.beginPath();
                canvasCtx.moveTo(startX, startY);
                canvasCtx.lineTo(endX, endY);
                canvasCtx.stroke();
            }
        }

        // 可视化类型和颜色方案更改
        visualizerType.addEventListener('change', function() {
            if (isPlaying) {
                cancelAnimationFrame(animationId);
                visualize();
            }
        });

        colorScheme.addEventListener('change', function() {
            if (isPlaying) {
                cancelAnimationFrame(animationId);
                visualize();
            }
        });

        // 窗口大小变化时调整Canvas
        window.addEventListener('resize', function() {
            visualizerCanvas.width = visualizerCanvas.clientWidth;
            visualizerCanvas.height = visualizerCanvas.clientHeight;
            
            if (isPlaying) {
                cancelAnimationFrame(animationId);
                visualize();
            }
        });

        // 初始化示例音频
        window.addEventListener('load', function() {
            // 设置默认步进大小
            stepSizeValue.textContent = `${stepSize.value} 秒`;
            stepSizeInSeconds = parseInt(stepSize.value);
            
            // 显示初始说明
            trackTitle.textContent = "步进音乐播放器";
            trackArtist.textContent = "请上传音频文件开始使用";
            trackAlbum.textContent = "支持 MP3, WAV, OGG 格式";
            
            // 绘制初始频谱（静态）
            drawInitialVisualization();
            
            // 添加点击事件以初始化音频上下文
            document.body.addEventListener('click', function initOnClick() {
                if (!audioContext) {
                    initAudioContext();
                    console.log('通过点击初始化音频上下文');
                }
                // 移除事件监听器，避免重复初始化
                document.body.removeEventListener('click', initOnClick);
            });
        });

        // 绘制初始静态频谱
        function drawInitialVisualization() {
            const width = visualizerCanvas.width;
            const height = visualizerCanvas.height;
            const colors = colorSchemes[colorScheme.value];
            
            // 清除画布
            canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            canvasCtx.fillRect(0, 0, width, height);
            
            // 绘制说明文本
            canvasCtx.fillStyle = colors[0];
            canvasCtx.font = "bold 20px Arial";
            canvasCtx.textAlign = "center";
            canvasCtx.fillText("上传音频文件查看频谱分析", width/2, height/2 - 20);
            
            canvasCtx.fillStyle = colors[1];
            canvasCtx.font = "16px Arial";
            canvasCtx.fillText("支持 MP3, WAV, OGG 格式", width/2, height/2 + 20);
            
            // 绘制示例波形
            canvasCtx.strokeStyle = colors[0];
            canvasCtx.lineWidth = 3;
            canvasCtx.beginPath();
            
            const centerY = height/2 + 60;
            const amplitude = 30;
            const frequency = 0.02;
            
            for (let x = 0; x < width; x++) {
                const y = centerY + Math.sin(x * frequency) * amplitude;
                
                if (x === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }
            }
            
            canvasCtx.stroke();
        }
        
        // 添加一个测试音频按钮（用于调试）
        const testButton = document.createElement('button');
        testButton.textContent = '测试频谱';
        testButton.style.position = 'fixed';
        testButton.style.bottom = '10px';
        testButton.style.right = '10px';
        testButton.style.padding = '10px';
        testButton.style.background = '#00dbde';
        testButton.style.color = 'white';
        testButton.style.border = 'none';
        testButton.style.borderRadius = '5px';
        testButton.style.cursor = 'pointer';
        testButton.style.zIndex = '1000';
        testButton.style.display = 'none'; // 默认隐藏，需要时显示
        
        testButton.addEventListener('click', function() {
            // 生成测试音频
            generateTestAudio();
        });
        
        document.body.appendChild(testButton);
        
        // 生成测试音频函数
        function generateTestAudio() {
            if (!audioContext) {
                initAudioContext();
            }
            
            const oscillator = audioContext.createOscillator();
            oscillator.type = 'sine';
            oscillator.frequency.setValueAtTime(440, audioContext.currentTime); // A4 音符
            
            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            
            // 创建分析器
            if (!analyser) {
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
            }
            
            oscillator.connect(gainNode);
            gainNode.connect(analyser);
            analyser.connect(audioContext.destination);
            
            // 开始测试音频
            oscillator.start();
            
            // 开始可视化
            isPlaying = true;
            visualize();
            
            // 5秒后停止测试
            setTimeout(() => {
                oscillator.stop();
                isPlaying = false;
                cancelAnimationFrame(animationId);
                alert('测试完成，频谱功能正常工作！');
            }, 5000);
        }
    </script>
</body>
</html>