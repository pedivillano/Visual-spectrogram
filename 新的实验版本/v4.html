<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>步进音乐播放器与频谱分析器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #f1f1f1;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00dbde, #fc00ff);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #aaa;
            max-width: 600px;
            margin: 0 auto;
            line-height: 1.6;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .player-panel, .visualizer-panel {
            background: rgba(30, 30, 46, 0.8);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .panel-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #00dbde;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-title i {
            font-size: 1.3rem;
        }
        
        /* 文件上传区域 */
        .file-upload-area {
            background: rgba(40, 40, 60, 0.8);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px dashed rgba(0, 219, 222, 0.4);
            text-align: center;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            border-color: #00dbde;
            background: rgba(40, 40, 60, 0.9);
        }
        
        .file-label {
            display: block;
            cursor: pointer;
            padding: 15px;
        }
        
        .file-label i {
            font-size: 3rem;
            color: #00dbde;
            margin-bottom: 15px;
        }
        
        .file-label h3 {
            margin-bottom: 10px;
            font-size: 1.3rem;
        }
        
        .file-label p {
            color: #aaa;
            margin-bottom: 15px;
        }
        
        .upload-btn {
            display: inline-block;
            padding: 12px 25px;
            background: linear-gradient(90deg, #00dbde, #fc00ff);
            color: white;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 219, 222, 0.4);
        }
        
        .file-input {
            display: none;
        }
        
        .selected-file {
            margin-top: 15px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            font-size: 0.9rem;
            word-break: break-all;
        }
        
        /* 播放器控制区域 */
        .player-controls {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .track-info {
            text-align: center;
            padding: 20px;
            background: rgba(40, 40, 60, 0.8);
            border-radius: 10px;
        }
        
        .track-title {
            font-size: 1.6rem;
            margin-bottom: 8px;
            color: #fff;
        }
        
        .track-artist, .track-album {
            color: #aaa;
            font-size: 1rem;
            margin-bottom: 5px;
        }
        
        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 15px;
        }
        
        .progress-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            cursor: pointer;
            margin: 15px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00dbde, #fc00ff);
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s;
        }
        
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 25px;
            margin: 20px 0;
        }
        
        .control-btn {
            background: rgba(40, 40, 60, 0.8);
            border: none;
            color: #fff;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .control-btn:hover {
            background: rgba(0, 219, 222, 0.2);
            transform: scale(1.1);
        }
        
        .play-btn {
            background: linear-gradient(135deg, #00dbde, #fc00ff);
            width: 70px;
            height: 70px;
            font-size: 1.8rem;
        }
        
        .step-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }
        
        .step-btn {
            padding: 12px 25px;
            background: rgba(40, 40, 60, 0.8);
            border: none;
            color: #fff;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
        }
        
        .step-btn:hover {
            background: rgba(0, 219, 222, 0.2);
            transform: translateY(-3px);
        }
        
        .volume-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .volume-slider {
            flex-grow: 1;
            height: 8px;
            -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            outline: none;
        }
        
        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #00dbde;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 219, 222, 0.8);
        }
        
        /* 频谱分析区域 */
        .visualizer-container {
            width: 100%;
            height: 350px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin-bottom: 25px;
        }
        
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        .visualizer-settings {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .setting-group {
            flex: 1;
            min-width: 180px;
        }
        
        .setting-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 0.95rem;
        }
        
        .setting-group select, .setting-group input {
            width: 100%;
            padding: 12px;
            background: rgba(40, 40, 60, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
        }
        
        .step-size-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .step-size-container input {
            flex-grow: 1;
        }
        
        .step-size-value {
            min-width: 40px;
            font-weight: bold;
            color: #00dbde;
        }
        
        .instructions {
            background: rgba(40, 40, 60, 0.8);
            border-radius: 10px;
            padding: 25px;
            margin-top: 40px;
        }
        
        .instructions h3 {
            color: #00dbde;
            margin-bottom: 20px;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .instructions ul {
            padding-left: 20px;
            color: #aaa;
            line-height: 1.8;
        }
        
        .instructions li {
            margin-bottom: 12px;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #777;
            font-size: 0.9rem;
        }
        
        .audio-status {
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 100, 100, 0.1);
            border-left: 4px solid #ff6464;
            border-radius: 4px;
            font-size: 0.9rem;
            display: none;
        }
        
        .audio-status.show {
            display: block;
        }
        
        .audio-status i {
            margin-right: 8px;
            color: #ff6464;
        }
        
        /* 加载动画 */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00dbde;
            font-size: 1.2rem;
        }
        
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        /* 响应式调整 */
        @media (max-width: 600px) {
            .control-buttons {
                gap: 15px;
            }
            
            .control-btn {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .play-btn {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }
            
            .step-controls {
                flex-direction: column;
                align-items: center;
            }
            
            .step-btn {
                width: 80%;
                justify-content: center;
            }
            
            .visualizer-settings {
                flex-direction: column;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-music"></i> 步进音乐播放器与频谱分析器</h1>
            <p class="subtitle">上传音频文件，以步进方式控制播放，同时实时查看音频频谱分析。支持MP3、WAV、OGG格式。</p>
        </header>
        
        <div class="main-content">
            <div class="player-panel">
                <h2 class="panel-title"><i class="fas fa-play-circle"></i> 播放控制</h2>
                
                <div class="file-upload-area">
                    <label for="audioFile" class="file-label">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>点击上传音频文件</h3>
                        <p>支持 MP3, WAV, OGG 格式，最大50MB</p>
                        <div class="upload-btn">选择文件</div>
                    </label>
                    <input type="file" id="audioFile" class="file-input" accept="audio/*">
                    <div id="selectedFileInfo" class="selected-file" style="display: none;">
                        <strong>已选择文件:</strong> <span id="fileName"></span>
                    </div>
                </div>
                
                <div id="audioStatus" class="audio-status">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="statusMessage">音频上下文未启动，请点击播放按钮</span>
                </div>
                
                <div class="player-controls">
                    <div class="track-info">
                        <div class="track-title" id="trackTitle">等待音频文件</div>
                        <div class="track-artist" id="trackArtist">上传音频文件开始播放</div>
                        <div class="track-album" id="trackAlbum">时长: --:--</div>
                        
                        <div class="time-display">
                            <span id="currentTime">00:00</span>
                            <span id="totalTime">00:00</span>
                        </div>
                        
                        <div class="progress-container" id="progressContainer">
                            <div class="progress-bar" id="progressBar"></div>
                        </div>
                    </div>
                    
                    <div class="control-buttons">
                        <button class="control-btn" id="stepBackwardBtn" title="后退">
                            <i class="fas fa-step-backward"></i>
                        </button>
                        
                        <button class="control-btn play-btn" id="playPauseBtn" title="播放/暂停">
                            <i class="fas fa-play" id="playIcon"></i>
                        </button>
                        
                        <button class="control-btn" id="stepForwardBtn" title="前进">
                            <i class="fas fa-step-forward"></i>
                        </button>
                    </div>
                    
                    <div class="step-controls">
                        <button class="step-btn" id="smallStepBackwardBtn">
                            <i class="fas fa-backward"></i> 后退1秒
                        </button>
                        <button class="step-btn" id="smallStepForwardBtn">
                            <i class="fas fa-forward"></i> 前进1秒
                        </button>
                    </div>
                    
                    <div class="volume-control">
                        <i class="fas fa-volume-down"></i>
                        <input type="range" min="0" max="100" value="70" class="volume-slider" id="volumeSlider">
                        <i class="fas fa-volume-up"></i>
                    </div>
                </div>
            </div>
            
            <div class="visualizer-panel">
                <h2 class="panel-title"><i class="fas fa-wave-square"></i> 频谱分析</h2>
                
                <div class="visualizer-container">
                    <canvas id="visualizerCanvas"></canvas>
                    <div id="loadingIndicator" class="loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i> 正在分析音频...
                    </div>
                </div>
                
                <div class="visualizer-settings">
                    <div class="setting-group">
                        <label for="visualizerType"><i class="fas fa-chart-bar"></i> 频谱类型</label>
                        <select id="visualizerType">
                            <option value="bars">柱状频谱</option>
                            <option value="waveform">波形图</option>
                            <option value="circular">圆形频谱</option>
                            <option value="particles">粒子效果</option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label for="colorScheme"><i class="fas fa-palette"></i> 颜色方案</label>
                        <select id="colorScheme">
                            <option value="neon">霓虹渐变</option>
                            <option value="ocean">海洋蓝</option>
                            <option value="fire">火焰红</option>
                            <option value="forest">森林绿</option>
                            <option value="rainbow">彩虹色</option>
                        </select>
                    </div>
                    
                    <div class="setting-group">
                        <label for="stepSize"><i class="fas fa-ruler"></i> 步进大小</label>
                        <div class="step-size-container">
                            <input type="range" id="stepSize" min="1" max="10" value="5">
                            <span id="stepSizeValue" class="step-size-value">5 秒</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="instructions">
            <h3><i class="fas fa-info-circle"></i> 使用说明</h3>
            <ul>
                <li><strong>上传音频：</strong>点击"选择文件"按钮上传音频文件，支持MP3、WAV、OGG格式</li>
                <li><strong>播放控制：</strong>使用播放/暂停按钮控制音频播放，使用前进/后退按钮进行步进控制</li>
                <li><strong>步进播放：</strong>使用"前进1秒"/"后退1秒"按钮进行精确时间控制，或使用步进按钮进行自定义步进控制</li>
                <li><strong>频谱分析：</strong>右侧实时显示音频频谱，可选择不同频谱类型和颜色方案</li>
                <li><strong>调整设置：</strong>可调整步进大小（1-10秒）、频谱类型和颜色方案</li>
                <li><strong>音量控制：</strong>使用音量滑块调整播放音量</li>
                <li><strong>提示：</strong>某些浏览器需要用户交互才能启动音频，请先点击播放按钮</li>
            </ul>
        </div>
        
        <footer>
            <p>步进音乐播放器与频谱分析器 &copy; 2023 | 使用 Web Audio API 和 Canvas 技术构建</p>
        </footer>
    </div>

    <script>
        // 获取DOM元素
        const audioFileInput = document.getElementById('audioFile');
        const selectedFileInfo = document.getElementById('selectedFileInfo');
        const fileName = document.getElementById('fileName');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const playIcon = document.getElementById('playIcon');
        const stepBackwardBtn = document.getElementById('stepBackwardBtn');
        const stepForwardBtn = document.getElementById('stepForwardBtn');
        const smallStepBackwardBtn = document.getElementById('smallStepBackwardBtn');
        const smallStepForwardBtn = document.getElementById('smallStepForwardBtn');
        const progressBar = document.getElementById('progressBar');
        const progressContainer = document.getElementById('progressContainer');
        const currentTimeDisplay = document.getElementById('currentTime');
        const totalTimeDisplay = document.getElementById('totalTime');
        const volumeSlider = document.getElementById('volumeSlider');
        const visualizerCanvas = document.getElementById('visualizerCanvas');
        const visualizerType = document.getElementById('visualizerType');
        const colorScheme = document.getElementById('colorScheme');
        const stepSize = document.getElementById('stepSize');
        const stepSizeValue = document.getElementById('stepSizeValue');
        const trackTitle = document.getElementById('trackTitle');
        const trackArtist = document.getElementById('trackArtist');
        const trackAlbum = document.getElementById('trackAlbum');
        const audioStatus = document.getElementById('audioStatus');
        const statusMessage = document.getElementById('statusMessage');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // 初始化音频上下文和分析器
        let audioContext = null;
        let audioSource = null;
        let analyser = null;
        let audioElement = null;
        let isPlaying = false;
        let animationId = null;
        let stepSizeInSeconds = 5;
        let audioInitialized = false;

        // 初始化Canvas
        const canvasCtx = visualizerCanvas.getContext('2d');
        visualizerCanvas.width = visualizerCanvas.clientWidth;
        visualizerCanvas.height = visualizerCanvas.clientHeight;

        // 颜色方案
        const colorSchemes = {
            neon: ['#00dbde', '#fc00ff'],
            ocean: ['#1e3c72', '#2a5298'],
            fire: ['#ff416c', '#ff4b2b'],
            forest: ['#56ab2f', '#a8e063'],
            rainbow: ['#ff0000', '#ff9900', '#ffff00', '#00ff00', '#0099ff', '#6600ff']
        };

        // 粒子效果专用
        let particles = [];
        const particleCount = 150;

        // 初始化音频上下文
        function initAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('音频上下文已初始化');
                    updateStatus('音频上下文已就绪', 'success');
                } catch (error) {
                    console.error('无法初始化音频上下文:', error);
                    updateStatus('无法初始化音频上下文: ' + error.message, 'error');
                }
            }
            return audioContext;
        }

        // 更新状态显示
        function updateStatus(message, type = 'info') {
            statusMessage.textContent = message;
            audioStatus.classList.add('show');
            
            if (type === 'success') {
                audioStatus.style.background = 'rgba(100, 255, 100, 0.1)';
                audioStatus.style.borderLeftColor = '#64ff64';
                audioStatus.querySelector('i').className = 'fas fa-check-circle';
                audioStatus.querySelector('i').style.color = '#64ff64';
                
                // 3秒后隐藏成功消息
                setTimeout(() => {
                    audioStatus.classList.remove('show');
                }, 3000);
            } else if (type === 'error') {
                audioStatus.style.background = 'rgba(255, 100, 100, 0.1)';
                audioStatus.style.borderLeftColor = '#ff6464';
                audioStatus.querySelector('i').className = 'fas fa-exclamation-triangle';
                audioStatus.querySelector('i').style.color = '#ff6464';
            } else {
                audioStatus.style.background = 'rgba(255, 255, 100, 0.1)';
                audioStatus.style.borderLeftColor = '#ffff64';
                audioStatus.querySelector('i').className = 'fas fa-info-circle';
                audioStatus.querySelector('i').style.color = '#ffff64';
            }
        }

        // 加载音频文件
        audioFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // 验证文件大小（最大50MB）
            if (file.size > 50 * 1024 * 1024) {
                updateStatus('文件太大，请选择小于50MB的文件', 'error');
                return;
            }

            // 显示文件名
            fileName.textContent = file.name;
            selectedFileInfo.style.display = 'block';
            
            // 更新曲目信息
            const nameWithoutExt = file.name.replace(/\.[^/.]+$/, "");
            trackTitle.textContent = nameWithoutExt;
            trackArtist.textContent = "未知艺术家";
            trackAlbum.textContent = "文件大小: " + (file.size / (1024 * 1024)).toFixed(2) + " MB";

            // 停止之前的音频和可视化
            if (audioElement) {
                audioElement.pause();
                if (audioSource) {
                    audioSource.disconnect();
                }
                cancelAnimationFrame(animationId);
            }

            // 显示加载指示器
            loadingIndicator.style.display = 'block';
            
            // 创建音频元素
            const fileURL = URL.createObjectURL(file);
            audioElement = new Audio(fileURL);
            audioElement.crossOrigin = "anonymous";
            
            // 重置音频源和分析器
            audioSource = null;
            analyser = null;
            audioInitialized = false;
            
            // 设置音量
            audioElement.volume = volumeSlider.value / 100;
            
            // 更新总时长
            audioElement.addEventListener('loadedmetadata', function() {
                loadingIndicator.style.display = 'none';
                const duration = audioElement.duration;
                totalTimeDisplay.textContent = formatTime(duration);
                trackAlbum.textContent = `时长: ${formatTime(duration)} | 文件大小: ${(file.size / (1024 * 1024)).toFixed(2)} MB`;
                updateStatus('音频文件已加载，点击播放按钮开始', 'success');
            });

            // 当音频播放时更新进度
            audioElement.addEventListener('timeupdate', updateProgress);
            
            // 音频结束时重置状态
            audioElement.addEventListener('ended', function() {
                isPlaying = false;
                playIcon.className = 'fas fa-play';
                playPauseBtn.classList.remove('pulse');
                cancelAnimationFrame(animationId);
                updateStatus('播放结束', 'info');
            });
            
            // 错误处理
            audioElement.addEventListener('error', function(e) {
                loadingIndicator.style.display = 'none';
                updateStatus('音频加载失败: ' + e.message, 'error');
            });
            
            // 重置播放按钮
            playIcon.className = 'fas fa-play';
            isPlaying = false;
            playPauseBtn.classList.remove('pulse');
        });

        // 初始化音频分析器
        function initAudioAnalyser() {
            if (!audioContext) {
                initAudioContext();
            }
            
            if (audioContext.state === 'suspended') {
                updateStatus('音频上下文已暂停，请点击播放按钮恢复', 'info');
            }
            
            try {
                // 创建分析器
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;
                analyser.smoothingTimeConstant = 0.8;
                
                // 创建音频源并连接到分析器
                if (audioElement && !audioSource) {
                    audioSource = audioContext.createMediaElementSource(audioElement);
                    audioSource.connect(analyser);
                    analyser.connect(audioContext.destination);
                }
                
                audioInitialized = true;
                console.log('音频分析器已初始化');
                return true;
            } catch (error) {
                console.error('初始化音频分析器失败:', error);
                updateStatus('初始化音频分析器失败: ' + error.message, 'error');
                return false;
            }
        }

        // 播放/暂停音频
        playPauseBtn.addEventListener('click', async function() {
            if (!audioElement) {
                updateStatus('请先选择音频文件', 'error');
                return;
            }

            try {
                // 如果是第一次播放，初始化音频上下文和分析器
                if (!audioInitialized) {
                    if (!initAudioContext()) return;
                    if (!initAudioAnalyser()) return;
                }

                // 恢复音频上下文（如果被暂停）
                if (audioContext.state === 'suspended') {
                    await audioContext.resume();
                }

                if (isPlaying) {
                    // 暂停音频
                    audioElement.pause();
                    playIcon.className = 'fas fa-play';
                    playPauseBtn.classList.remove('pulse');
                    
                    // 停止可视化动画
                    if (animationId) {
                        cancelAnimationFrame(animationId);
                        animationId = null;
                    }
                    
                    updateStatus('已暂停', 'info');
                } else {
                    // 播放音频
                    await audioElement.play();
                    playIcon.className = 'fas fa-pause';
                    playPauseBtn.classList.add('pulse');
                    
                    // 确保分析器已正确连接
                    if (!analyser) {
                        if (!initAudioAnalyser()) return;
                    }
                    
                    // 开始可视化
                    visualize();
                    updateStatus('播放中...', 'success');
                }
                
                isPlaying = !isPlaying;
            } catch (error) {
                console.error('播放失败:', error);
                updateStatus('播放失败: ' + error.message, 'error');
            }
        });

        // 步进控制
        stepBackwardBtn.addEventListener('click', () => stepAudio(-stepSizeInSeconds));
        stepForwardBtn.addEventListener('click', () => stepAudio(stepSizeInSeconds));
        smallStepBackwardBtn.addEventListener('click', () => stepAudio(-1));
        smallStepForwardBtn.addEventListener('click', () => stepAudio(1));

        // 步进音频
        function stepAudio(seconds) {
            if (!audioElement) {
                updateStatus('请先选择音频文件', 'error');
                return;
            }
            
            const newTime = audioElement.currentTime + seconds;
            audioElement.currentTime = Math.max(0, Math.min(newTime, audioElement.duration));
            updateProgress();
            
            // 如果音频在播放，确保可视化继续
            if (isPlaying && !animationId) {
                visualize();
            }
        }

        // 更新进度条
        function updateProgress() {
            if (!audioElement) return;
            
            const currentTime = audioElement.currentTime;
            const duration = audioElement.duration;
            
            if (duration) {
                const progressPercent = (currentTime / duration) * 100;
                progressBar.style.width = `${progressPercent}%`;
                currentTimeDisplay.textContent = formatTime(currentTime);
            }
        }

        // 点击进度条跳转
        progressContainer.addEventListener('click', function(e) {
            if (!audioElement || !audioElement.duration) return;
            
            const rect = this.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const width = rect.width;
            const clickPercent = clickX / width;
            
            audioElement.currentTime = clickPercent * audioElement.duration;
            updateProgress();
            
            // 如果音频在播放，确保可视化继续
            if (isPlaying && !animationId) {
                visualize();
            }
        });

        // 音量控制
        volumeSlider.addEventListener('input', function() {
            if (audioElement) {
                audioElement.volume = this.value / 100;
            }
        });

        // 步进大小控制
        stepSize.addEventListener('input', function() {
            stepSizeInSeconds = parseInt(this.value);
            stepSizeValue.textContent = `${stepSizeInSeconds} 秒`;
        });

        // 格式化时间 (秒 -> MM:SS)
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // 频谱可视化
        function visualize() {
            // 如果已经有动画在运行，先停止它
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            // 检查必要的组件
            if (!analyser || !isPlaying || !audioElement || audioElement.paused) {
                return;
            }

            // 调整Canvas大小
            visualizerCanvas.width = visualizerCanvas.clientWidth;
            visualizerCanvas.height = visualizerCanvas.clientHeight;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            const width = visualizerCanvas.width;
            const height = visualizerCanvas.height;
            
            // 获取当前可视化类型
            const type = visualizerType.value;
            
            // 获取当前颜色方案
            const colors = colorSchemes[colorScheme.value];

            // 初始化粒子（如果需要）
            if (type === 'particles' && particles.length === 0) {
                initParticles(width, height);
            }

            // 绘制函数
            function draw() {
                // 检查是否仍在播放
                if (!isPlaying || !audioElement || audioElement.paused) {
                    cancelAnimationFrame(animationId);
                    animationId = null;
                    return;
                }
                
                // 请求下一帧
                animationId = requestAnimationFrame(draw);
                
                // 清除画布
                canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                canvasCtx.fillRect(0, 0, width, height);
                
                // 获取音频数据
                try {
                    if (type === 'waveform') {
                        analyser.getByteTimeDomainData(dataArray);
                    } else {
                        analyser.getByteFrequencyData(dataArray);
                    }
                } catch (error) {
                    console.error('获取音频数据失败:', error);
                    cancelAnimationFrame(animationId);
                    animationId = null;
                    return;
                }

                // 根据类型绘制
                switch(type) {
                    case 'bars':
                        drawBars(dataArray, bufferLength, width, height, colors);
                        break;
                    case 'waveform':
                        drawWaveform(dataArray, bufferLength, width, height, colors);
                        break;
                    case 'circular':
                        drawCircular(dataArray, bufferLength, width, height, colors);
                        break;
                    case 'particles':
                        drawParticles(dataArray, bufferLength, width, height, colors);
                        break;
                }
            }

            // 开始绘制
            draw();
        }

        // 绘制柱状频谱
        function drawBars(dataArray, bufferLength, width, height, colors) {
            const barWidth = (width / bufferLength) * 2.5;
            let barHeight;
            let x = 0;

            // 只使用前1/3的数据（低频部分，视觉效果好）
            const dataToShow = Math.floor(bufferLength / 3);

            for (let i = 0; i < dataToShow; i++) {
                barHeight = (dataArray[i] / 255) * height * 0.8;
                
                // 创建渐变颜色
                const gradient = canvasCtx.createLinearGradient(0, height - barHeight, 0, height);
                
                if (colors.length === 2) {
                    gradient.addColorStop(0, colors[0]);
                    gradient.addColorStop(1, colors[1]);
                } else {
                    // 彩虹色方案
                    const colorIndex = Math.floor(i / dataToShow * colors.length);
                    gradient.addColorStop(0, colors[colorIndex]);
                    gradient.addColorStop(1, colors[(colorIndex + 1) % colors.length]);
                }
                
                canvasCtx.fillStyle = gradient;
                canvasCtx.fillRect(x, height - barHeight, barWidth, barHeight);
                
                x += barWidth + 1;
            }
        }

        // 绘制波形图
        function drawWaveform(dataArray, bufferLength, width, height, colors) {
            canvasCtx.lineWidth = 2;
            
            // 创建渐变
            const gradient = canvasCtx.createLinearGradient(0, 0, width, 0);
            
            if (colors.length === 2) {
                gradient.addColorStop(0, colors[0]);
                gradient.addColorStop(1, colors[1]);
            } else {
                // 彩虹色方案
                for (let i = 0; i < colors.length; i++) {
                    gradient.addColorStop(i / (colors.length - 1), colors[i]);
                }
            }
            
            canvasCtx.strokeStyle = gradient;
            canvasCtx.beginPath();

            const sliceWidth = width * 1.0 / bufferLength;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                const y = (v * height / 2) + height / 2;

                if (i === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }

                x += sliceWidth;
            }

            canvasCtx.lineTo(width, height / 2);
            canvasCtx.stroke();
        }

        // 绘制圆形频谱
        function drawCircular(dataArray, bufferLength, width, height, colors) {
            const centerX = width / 2;
            const centerY = height / 2;
            const radius = Math.min(width, height) * 0.25;
            
            canvasCtx.lineWidth = 2;
            
            // 绘制背景圆
            canvasCtx.beginPath();
            canvasCtx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            canvasCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            canvasCtx.stroke();
            
            // 只使用部分数据
            const dataToShow = Math.floor(bufferLength / 2);
            const angleStep = (Math.PI * 2) / dataToShow;
            
            for (let i = 0; i < dataToShow; i++) {
                const amplitude = (dataArray[i] / 255) * radius * 1.5;
                const angle = i * angleStep;
                
                // 创建渐变颜色
                let color;
                if (colors.length === 2) {
                    const gradient = canvasCtx.createLinearGradient(
                        centerX + Math.cos(angle) * radius,
                        centerY + Math.sin(angle) * radius,
                        centerX + Math.cos(angle) * (radius + amplitude),
                        centerY + Math.sin(angle) * (radius + amplitude)
                    );
                    gradient.addColorStop(0, colors[0]);
                    gradient.addColorStop(1, colors[1]);
                    canvasCtx.strokeStyle = gradient;
                } else {
                    // 彩虹色方案
                    const colorIndex = Math.floor(i / dataToShow * colors.length);
                    canvasCtx.strokeStyle = colors[colorIndex];
                }
                
                canvasCtx.lineWidth = 2;
                
                const startX = centerX + Math.cos(angle) * radius;
                const startY = centerY + Math.sin(angle) * radius;
                const endX = centerX + Math.cos(angle) * (radius + amplitude);
                const endY = centerY + Math.sin(angle) * (radius + amplitude);
                
                canvasCtx.beginPath();
                canvasCtx.moveTo(startX, startY);
                canvasCtx.lineTo(endX, endY);
                canvasCtx.stroke();
            }
        }

        // 初始化粒子
        function initParticles(width, height) {
            particles = [];
            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x: Math.random() * width,
                    y: Math.random() * height,
                    size: Math.random() * 5 + 1,
                    speedX: Math.random() * 2 - 1,
                    speedY: Math.random() * 2 - 1,
                    color: `hsl(${Math.random() * 360}, 100%, 70%)`
                });
            }
        }

        // 绘制粒子效果
        function drawParticles(dataArray, bufferLength, width, height, colors) {
            // 更新粒子
            const avgFrequency = dataArray.slice(0, 100).reduce((a, b) => a + b, 0) / 100;
            const intensity = avgFrequency / 255;
            
            for (let i = 0; i < particles.length; i++) {
                let p = particles[i];
                
                // 根据音频强度移动粒子
                p.x += p.speedX * (intensity + 0.5);
                p.y += p.speedY * (intensity + 0.5);
                
                // 边界检查
                if (p.x < 0) p.x = width;
                if (p.x > width) p.x = 0;
                if (p.y < 0) p.y = height;
                if (p.y > height) p.y = 0;
                
                // 绘制粒子
                canvasCtx.beginPath();
                canvasCtx.arc(p.x, p.y, p.size * (intensity + 0.5), 0, Math.PI * 2);
                
                // 使用颜色方案
                if (colors[0] === '#ff0000' && colors.length > 2) {
                    // 彩虹色方案
                    const hue = (p.x / width) * 360;
                    canvasCtx.fillStyle = `hsl(${hue}, 100%, 70%)`;
                } else {
                    // 渐变颜色
                    const gradient = canvasCtx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.size);
                    gradient.addColorStop(0, colors[0]);
                    gradient.addColorStop(1, colors[1] || colors[0]);
                    canvasCtx.fillStyle = gradient;
                }
                
                canvasCtx.fill();
            }
        }

        // 可视化类型和颜色方案更改
        visualizerType.addEventListener('change', function() {
            if (type === 'particles' && particles.length === 0) {
                initParticles(visualizerCanvas.width, visualizerCanvas.height);
            }
            
            if (isPlaying) {
                // 重启可视化
                visualize();
            }
        });

        colorScheme.addEventListener('change', function() {
            if (isPlaying) {
                // 重启可视化
                visualize();
            }
        });

        // 窗口大小变化时调整Canvas
        window.addEventListener('resize', function() {
            visualizerCanvas.width = visualizerCanvas.clientWidth;
            visualizerCanvas.height = visualizerCanvas.clientHeight;
            
            if (isPlaying) {
                // 重启可视化
                visualize();
            }
        });

        // 初始化
        window.addEventListener('load', function() {
            // 设置默认步进大小
            stepSizeValue.textContent = `${stepSize.value} 秒`;
            stepSizeInSeconds = parseInt(stepSize.value);
            
            // 显示初始说明
            trackTitle.textContent = "步进音乐播放器";
            trackArtist.textContent = "请上传音频文件开始使用";
            trackAlbum.textContent = "支持 MP3, WAV, OGG 格式";
            
            // 绘制初始频谱（静态）
            drawInitialVisualization();
            
            // 提前初始化音频上下文（通过用户点击）
            document.addEventListener('click', function initOnClick() {
                if (!audioContext) {
                    initAudioContext();
                    updateStatus('音频上下文已就绪，请上传音频文件', 'success');
                }
            }, { once: true });
        });

        // 绘制初始静态频谱
        function drawInitialVisualization() {
            const width = visualizerCanvas.width;
            const height = visualizerCanvas.height;
            const colors = colorSchemes[colorScheme.value];
            
            // 清除画布
            canvasCtx.fillStyle = 'rgba(0, 0, 0, 0.1)';
            canvasCtx.fillRect(0, 0, width, height);
            
            // 绘制说明文本
            canvasCtx.fillStyle = colors[0];
            canvasCtx.font = "bold 20px Arial";
            canvasCtx.textAlign = "center";
            canvasCtx.fillText("上传音频文件查看频谱分析", width/2, height/2 - 20);
            
            canvasCtx.fillStyle = colors[1] || colors[0];
            canvasCtx.font = "16px Arial";
            canvasCtx.fillText("支持 MP3, WAV, OGG 格式", width/2, height/2 + 20);
            
            // 绘制示例波形
            canvasCtx.strokeStyle = colors[0];
            canvasCtx.lineWidth = 3;
            canvasCtx.beginPath();
            
            const centerY = height/2 + 60;
            const amplitude = 30;
            const frequency = 0.02;
            
            for (let x = 0; x < width; x++) {
                const y = centerY + Math.sin(x * frequency) * amplitude;
                
                if (x === 0) {
                    canvasCtx.moveTo(x, y);
                } else {
                    canvasCtx.lineTo(x, y);
                }
            }
            
            canvasCtx.stroke();
        }
    </script>
</body>
</html>